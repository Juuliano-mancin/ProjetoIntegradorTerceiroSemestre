<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Aluno</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="estilo.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
</head>

<body class="text-white">
  <header class="p-3">
    <h1 class="fw-bold ms-3">Editar dados aluno</h1>
  </header>

  <nav class="navbar navbar-expand-lg px-3">
    <div class="container-fluid">
      <span class="navbar-text me-4">
        Login: <span>Administrador</span>
      </span>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown"
        aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav ms-auto d-flex flex-wrap justify-content-evenly w-100">

          <!-- Home -->
          <li class="nav-item">
            <a class="nav-link fs-5" href="page_admin.html">
              <i class="bi bi-house-door-fill me-1"></i> Home
            </a>
          </li>

          <!-- Alunos -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle fs-5" href="#" role="button" data-bs-toggle="dropdown"
              aria-expanded="false">
              <i class="bi bi-person-lines-fill me-1"></i> Alunos
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item fs-5" href="cadastro_alunos.html"><i class="bi bi-person-plus me-2"></i>Cadastro de alunos</a></li>
              <li><a class="dropdown-item fs-5" href="listagem_alunos.html"><i class="bi bi-search me-2"></i>Consulta de alunos</a></li>
            </ul>
          </li>

          <!-- Turmas -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle fs-5" href="#" role="button" data-bs-toggle="dropdown"
              aria-expanded="false">
              <i class="bi bi-diagram-3 me-1"></i> Turmas
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item fs-5" href="cadastro_turmas.html"><i class="bi bi-plus-square me-2"></i>Cadastro de turmas</a></li>
              <li><a class="dropdown-item fs-5" href="listagem_turmas.html"><i class="bi bi-gear me-2"></i>Gerenciar turmas</a></li>
              <li><a class="dropdown-item fs-5" href="chamada.html"><i class="bi bi-clipboard-check me-2"></i>Chamada</a></li>
            </ul>
          </li>

          <!-- Professores -->
          <li class="nav-item">
            <a class="nav-link disabled fs-5" href="#"><i class="bi bi-person-vcard me-1"></i> Professores</a>
          </li>

          <!-- Planejamento -->
          <li class="nav-item">
            <a class="nav-link disabled fs-5" href="#"><i class="bi bi-journal-text me-1"></i> Planejamento de Aula</a>
          </li>

          <!-- Mais Opções -->
          <li class="nav-item d-flex align-items-center">
            <button class="btn btn-custom btn-sm fs-5" disabled>Mais Opções</button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-5 mb-5 p-5 rounded">
    <div class="row">
      <div class="col-md-4 pe-3">
        <div class="card bg-light border border-dark mb-4"> <div class="card-header bg-dark text-white"> <h5 class="card-title">Informações Cadastrais</h5>
          </div>
          <div class="card-body text-dark"> <dl class="row">
              <dt class="col-sm-5">Matrícula:</dt>
              <dd class="col-sm-7" id="matricula-display"></dd>

              <dt class="col-sm-5">CPF:</dt>
              <dd class="col-sm-7" id="cpf-display"></dd>

              <dt class="col-sm-5">RG:</dt>
              <dd class="col-sm-7" id="rg-display"></dd>

              <dt class="col-sm-5">Data Nasc.:</dt>
              <dd class="col-sm-7" id="nascimento-display"></dd>

              <dt class="col-sm-5">Idade:</dt>
              <dd class="col-sm-7" id="idade-display"></dd>

              <dt class="col-sm-5">Tipo Matrícula:</dt>
              <dd class="col-sm-7" id="tipo-matricula-display"></dd>

              <dt class="col-sm-5">Semestre:</dt>
              <dd class="col-sm-7" id="semestre-display"></dd>

              <dt class="col-sm-5">Data Cadastro:</dt>
              <dd class="col-sm-7" id="data-cadastro-display"></dd>
            </dl>
          </div>
        </div>

        <div class="card bg-light border border-dark"> <div class="card-header bg-dark text-white"> <h5 class="card-title">Endereço</h5>
          </div>
          <div class="card-body text-dark"> <address id="endereco-display"></address>
          </div>
        </div>
      </div>

      <div class="col-md-8 ps-3">
        <form id="form-editar-aluno" method="post" action="../backend/atualizar_aluno.php" class="needs-validation" novalidate>
          <input type="hidden" id="id_alunos" name="id_alunos">

          <div class="card bg-light border border-dark mb-4"> <div class="card-header bg-dark text-white"> <h5 class="card-title">Informações Pessoais</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="nome" class="form-label text-dark">Nome *</label> <input type="text" name="nome" class="form-control border border-dark rounded"
                             id="nome" required minlength="3" maxlength="100" pattern="[A-Za-zÀ-ú\s]+">
                  <div class="invalid-feedback">Por favor, insira um nome válido (3-100 caracteres, apenas letras).</div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="sobrenome" class="form-label text-dark">Sobrenome *</label> <input type="text" name="sobrenome" class="form-control border border-dark rounded"
                             id="sobrenome" required minlength="3" maxlength="150" pattern="[A-Za-zÀ-ú\s]+">
                  <div class="invalid-feedback">Por favor, insira um sobrenome válido (3-150 caracteres, apenas letras).</div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="nome_social" class="form-label text-dark">Nome Social</label> <input type="text" name="nome_social" class="form-control border border-dark rounded"
                             id="nome_social" maxlength="100" pattern="[A-Za-zÀ-ú\s]*">
                  <div class="invalid-feedback">O nome social deve conter apenas letras (até 100 caracteres).</div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="genero" class="form-label text-dark">Gênero *</label> <select name="genero" class="form-select border border-dark rounded" id="genero" required>
                    <option value="" disabled selected>Selecione...</option>
                    <option value="masculino">Masculino</option>
                    <option value="feminino">Feminino</option>
                    <option value="nao_binario">Não Binário</option>
                    <option value="transgenero">Transgênero</option>
                    <option value="outro">Outro</option>
                    <option value="nao_informado">Não Informado</option>
                  </select>
                  <div class="invalid-feedback">Por favor, selecione um gênero.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="card bg-light border border-dark mb-4"> <div class="card-header bg-dark text-white"> <h5 class="card-title">Contato</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="telefone" class="form-label text-dark">Telefone</label> <input type="tel" name="telefone" class="form-control border border-dark rounded"
                             id="telefone" placeholder="(00) 00000-0000" pattern="\([0-9]{2}\) [0-9]{4,5}-[0-9]{4}">
                  <div class="invalid-feedback">Por favor, insira um telefone válido no formato (00) 00000-0000.</div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="email" class="form-label text-dark">E-mail</label> <input type="email" name="email" class="form-control border border-dark rounded"
                             id="email" placeholder="usuario@gmail.com">
                  <div class="invalid-feedback">Por favor, insira um e-mail válido.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="card bg-light border border-dark"> <div class="card-header bg-dark text-white"> <h5 class="card-title">Contato de Emergência</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="cont_emergencia_nome" class="form-label text-dark">Nome</label> <input type="text" name="cont_emergencia_nome" class="form-control border border-dark rounded"
                             id="cont_emergencia_nome" maxlength="150" pattern="[A-Za-zÀ-ú\s]*">
                  <div class="invalid-feedback">O nome deve conter apenas letras (até 150 caracteres).</div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="cont_emergencia_relacao" class="form-label text-dark">Relacionamento</label> <select name="cont_emergencia_relacao" class="form-select border border-dark rounded" id="cont_emergencia_relacao">
                    <option value="nenhum">Nenhum</option>
                    <option value="pai_mae">Pai/Mãe</option>
                    <option value="parentesco_proximo">Parentesco Próço</option>
                    <option value="outros">Outros</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="cont_emergencia_contato" class="form-label text-dark">Contato</label> <input type="tel" name="cont_emergencia_contato" class="form-control border border-dark rounded"
                             id="cont_emergencia_contato" placeholder="(00) 00000-0000" pattern="\([0-9]{2}\) [0-9]{4,5}-[0-9]{4}">
                  <div class="invalid-feedback">Por favor, insira um telefone válido no formato (00) 00000-0000.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-secondary px-4 py-2 fw-bold" onclick="history.back()">
              <i class="bi bi-arrow-left me-2"></i>Voltar
            </button>
            <button type="submit" class="btn btn-primary px-4 py-2 fw-bold">
              <i class="bi bi-save me-2"></i>Salvar Alterações
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Função para formatar CPF
    function formatarCPF(cpf) {
      return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }

    // Função para formatar data
    function formatarData(data) {
      return new Date(data).toLocaleDateString('pt-BR');
    }

    // Função para calcular idade
    function calcularIdade(dataNascimento) {
      const hoje = new Date();
      const nascimento = new Date(dataNascimento);
      let idade = hoje.getFullYear() - nascimento.getFullYear();
      const mes = hoje.getMonth() - nascimento.getMonth();
      
      if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
        idade--;
      }
      
      return idade;
    }

    // Função para formatar telefone
    function formatarTelefone(telefone) {
      if (!telefone) return 'Não informado';
      const apenasNumeros = telefone.replace(/\D/g, '');
      return apenasNumeros.replace(/^(\d{2})(\d{4,5})(\d{4})$/, '($1) $2-$3');
    }

    // Carregar dados do aluno ao carregar a página
    document.addEventListener('DOMContentLoaded', function() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');

      if (!id) {
        alert('ID do aluno não informado');
        window.location.href = 'listagem_alunos.html';
        return;
      }

      fetch(`../backend/detalhar_aluno.php?id=${id}`)
        .then(response => {
          if (!response.ok) throw new Error('Erro ao buscar dados');
          return response.json();
        })
        .then(aluno => {
          // Preencher campos não editáveis (display)
          document.getElementById('matricula-display').textContent = aluno.matricula;
          document.getElementById('cpf-display').textContent = formatarCPF(aluno.cpf);
          document.getElementById('rg-display').textContent = aluno.rg;
          document.getElementById('nascimento-display').textContent = formatarData(aluno.nascimento);
          document.getElementById('idade-display').textContent = calcularIdade(aluno.nascimento) + ' anos';
          document.getElementById('tipo-matricula-display').textContent = 
            aluno.tipo_matricula === 'pre_vestibular' ? 'Pré-Vestibular' : 'Vestibulinho';
          document.getElementById('semestre-display').textContent = aluno.semestre + 'º Semestre';
          document.getElementById('data-cadastro-display').textContent = formatarData(aluno.data_cadastro);

          // Preencher endereço
          const endereco = `
            ${aluno.logradouro || 'Endereço não informado'}, ${aluno.numero || 'S/N'}${aluno.complemento ? ' - ' + aluno.complemento : ''}<br>
            ${aluno.bairro || ''}${aluno.bairro && aluno.cidade ? ', ' : ''}${aluno.cidade || ''}${aluno.uf ? ' - ' + aluno.uf : ''}<br>
            ${aluno.cep ? 'CEP: ' + aluno.cep.replace(/^(\d{5})(\d{3})$/, '$1-$2') : ''}
          `;
          document.getElementById('endereco-display').innerHTML = endereco;

          // Preencher formulário editável
          document.getElementById('id_alunos').value = aluno.id_alunos;
          document.getElementById('nome').value = aluno.nome;
          document.getElementById('nome_social').value = aluno.nome_social || '';
          document.getElementById('sobrenome').value = aluno.sobrenome;
          document.getElementById('genero').value = aluno.genero;
          document.getElementById('telefone').value = formatarTelefone(aluno.telefone);
          document.getElementById('email').value = aluno.email || '';
          document.getElementById('cont_emergencia_nome').value = aluno.cont_emergencia_nome || '';
          document.getElementById('cont_emergencia_relacao').value = aluno.cont_emergencia_relacao || 'nenhum';
          document.getElementById('cont_emergencia_contato').value = formatarTelefone(aluno.cont_emergencia_contato);
        })
        .catch(error => {
          console.error(error);
          alert('Erro ao carregar dados do aluno');
          window.location.href = 'listagem_alunos.html';
        });

      // Adicionar máscara ao telefone
      document.getElementById('telefone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
        value = value.replace(/(\d)(\d{4})$/, '$1-$2');
        e.target.value = value;
      });

      // Adicionar máscara ao contato de emergência
      document.getElementById('cont_emergencia_contato').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
        value = value.replace(/(\d)(\d{4})$/, '$1-$2');
        e.target.value = value;
      });

      // Validação do formulário
      const form = document.getElementById('form-editar-aluno');
      form.addEventListener('submit', function(e) {
        if (!form.checkValidity()) {
          e.preventDefault();
          e.stopPropagation();
        }

        form.classList.add('was-validated');
      }, false);
    });

    // Envio do formulário via AJAX
    document.getElementById('form-editar-aluno').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Limpar formatação dos telefones antes de enviar
      const telefone = document.getElementById('telefone');
      telefone.value = telefone.value.replace(/\D/g, '');
      
      const contatoEmergencia = document.getElementById('cont_emergencia_contato');
      contatoEmergencia.value = contatoEmergencia.value.replace(/\D/g, '');

      const formData = new FormData(this);
      const data = {};
      formData.forEach((value, key) => data[key] = value);
      
      fetch(this.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => {
        if (!response.ok) throw new Error('Erro na requisição');
        return response.json();
      })
      .then(result => {
        if (result.erro) {
          throw new Error(result.erro);
        }
        alert('Dados atualizados com sucesso!');
        window.location.href = 'listagem_alunos.html';
      })
      .catch(error => {
        console.error(error);
        alert(error.message || 'Erro ao atualizar aluno');
      });
    });
  </script>
</body>
</html>